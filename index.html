<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Price Scanner Pro</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; background: #1a1a1a; color: white; text-align: center; touch-action: manipulation; }
        .header { background: #28a745; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        #total-display { font-size: 3.5rem; font-weight: bold; }
        
        #video-container { position: relative; width: 100%; max-width: 500px; margin: auto; overflow: hidden; }
        video { width: 100%; height: auto; display: block; }
        
        #overlay { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            width: 250px; height: 80px; border: 4px solid #fff; border-radius: 10px;
            box-shadow: 0 0 0 9999px rgba(0,0,0,0.5); z-index: 10;
        }
        .scan-line { position: absolute; width: 100%; height: 2px; background: #28a745; top: 0; animation: scan 1.5s infinite linear; }
        @keyframes scan { 0% { top: 0; } 100% { top: 100%; } }

        #debug-box { font-family: monospace; font-size: 12px; color: #aaa; padding: 10px; }
        #status { background: #333; padding: 10px; font-weight: bold; }
        
        #item-list { list-style: none; padding: 0; margin: 10px; }
        li { background: #333; margin-bottom: 5px; padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; font-size: 1.2rem; border-left: 5px solid #28a745; }
    </style>
</head>
<body>

    <div class="header">
        <small>GRAND TOTAL</small>
        <div id="total-display">$0.00</div>
    </div>

    <div id="status">Starting Camera...</div>

    <div id="video-container">
        <video id="video" autoplay playsinline></video>
        <div id="overlay"><div class="scan-line"></div></div>
    </div>

    <div id="debug-box">Last seen: (nothing)</div>

    <ul id="item-list"></ul>

    <script>
        const video = document.getElementById('video');
        const status = document.getElementById('status');
        const debug = document.getElementById('debug-box');
        const totalDisplay = document.getElementById('total-display');
        
        let grandTotal = 0;
        let isProcessing = false;
        let worker = null;

        async function init() {
            try {
                // 1. Start Camera
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment', width: { ideal: 1280 } } 
                });
                video.srcObject = stream;

                // 2. Setup Tesseract Worker
                status.innerText = "Loading AI Engine...";
                worker = await Tesseract.createWorker('eng');
                
                // 3. Set Parameters to look ONLY for numbers and decimals
                await worker.setParameters({
                    tessedit_char_whitelist: '0123456789.$',
                });

                status.innerText = "READY: Frame the price";
                loop();
            } catch (err) {
                status.innerText = "Error: Check HTTPS or Camera Permissions";
            }
        }

        async function loop() {
            if (!isProcessing) {
                await scanFrame();
            }
            requestAnimationFrame(loop);
        }

        async function scanFrame() {
            isProcessing = true;
            
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 300;
            canvas.height = 100;

            // Draw and Zoom into the center (where the price box is)
            ctx.drawImage(video, 
                video.videoWidth/2 - 150, video.videoHeight/2 - 50, 300, 100, 
                0, 0, 300, 100
            );

            // OPTIONAL: Simple Black & White filter for OCR accuracy
            let imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            let pixels = imgData.data;
            for (var i = 0; i < pixels.length; i += 4) {
                let avg = (pixels[i] + pixels[i + 1] + pixels[i + 2]) / 3;
                let val = avg > 128 ? 255 : 0; // Threshold
                pixels[i] = pixels[i+1] = pixels[i+2] = val;
            }
            ctx.putImageData(imgData, 0, 0);

            try {
                const { data: { text } } = await worker.recognize(canvas);
                debug.innerText = `Raw Text: ${text.trim()}`;

                // Regex: Find a digit, a dot, and two more digits
                const match = text.replace('$', '').match(/\d+\.\d{2}/);

                if (match) {
                    const price = parseFloat(match[0]);
                    if (price > 0 && price < 500) { // Sanity check
                        handleFoundPrice(price);
                    } else {
                        isProcessing = false;
                    }
                } else {
                    isProcessing = false;
                }
            } catch (e) {
                isProcessing = false;
            }
        }

        function handleFoundPrice(price) {
            grandTotal += price;
            totalDisplay.innerText = `$${grandTotal.toFixed(2)}`;
            
            const li = document.createElement('li');
            li.innerHTML = `<span>Item</span><strong>$${price.toFixed(2)}</strong>`;
            document.getElementById('item-list').prepend(li);

            if (navigator.vibrate) navigator.vibrate(200);

            // Wait 3 seconds before allowing another scan
            status.innerText = `ADDED $${price.toFixed(2)}`;
            setTimeout(() => {
                isProcessing = false;
                status.innerText = "READY: Next item";
            }, 3000);
        }

        window.addEventListener('load', init);
    </script>
</body>
</html>