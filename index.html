<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto Price Scanner</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 20px; background: #f4f4f9; text-align: center; }
        #video-container { position: relative; width: 100%; max-width: 400px; margin: auto; border-radius: 15px; overflow: hidden; background: #000; }
        video { width: 100%; display: block; }
        /* The Scanning Target Box */
        #overlay { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            width: 200px; height: 60px; border: 3px solid #28a745; border-radius: 8px;
            box-shadow: 0 0 0 9999px rgba(0,0,0,0.6); z-index: 10;
        }
        .scan-line {
            position: absolute; width: 100%; height: 2px; background: red;
            top: 0; animation: scan 2s infinite linear;
        }
        @keyframes scan { 0% { top: 0; } 100% { top: 100%; } }
        .dashboard { background: white; padding: 15px; border-radius: 10px; margin-bottom: 15px; }
        #total-display { font-size: 2.5rem; font-weight: bold; color: #28a745; }
        #status { color: #666; font-size: 0.9rem; margin: 10px; height: 20px; }
        #item-list { list-style: none; padding: 0; margin-top: 20px; }
        li { background: white; margin-bottom: 5px; padding: 10px; border-radius: 5px; display: flex; justify-content: space-between; }
    </style>
</head>
<body>

    <div class="dashboard">
        <small>RUNNING TOTAL</small>
        <div id="total-display">$0.00</div>
    </div>

    <div id="video-container">
        <video id="video" autoplay playsinline></video>
        <div id="overlay"><div class="scan-line"></div></div>
    </div>

    <div id="status">Initializing Camera...</div>

    <ul id="item-list"></ul>
    <button onclick="location.reload()" style="margin-top:20px; padding: 10px;">Reset Scanner</button>

    <script>
        const video = document.getElementById('video');
        const status = document.getElementById('status');
        const totalDisplay = document.getElementById('total-display');
        let grandTotal = 0;
        let isProcessing = false;
        let lastScannedPrice = null;
        let scanTimer = null;

        // 1. Initialize Tesseract Worker once for speed
        let worker = null;
        async function initOCR() {
            status.innerText = "Loading Scanner Engine...";
            worker = await Tesseract.createWorker('eng');
            status.innerText = "Ready! Point at a price.";
            startAutoScan();
        }

        // 2. Start Camera
        async function initCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } } 
                });
                video.srcObject = stream;
                initOCR();
            } catch (err) {
                status.innerText = "Camera Error. Please use HTTPS.";
            }
        }

        // 3. The Auto-Scan Loop
        function startAutoScan() {
            scanTimer = setInterval(async () => {
                if (isProcessing) return; // Don't start a new scan if one is running
                
                isProcessing = true;
                const canvas = document.createElement('canvas');
                // We crop the image to just the area inside the green box for better accuracy
                const context = canvas.getContext('2d');
                canvas.width = 400; 
                canvas.height = 120;
                
                // Draw only the center portion of the video to the canvas
                context.drawImage(video, 
                    video.videoWidth / 2 - 200, video.videoHeight / 2 - 60, 400, 120, // Source
                    0, 0, 400, 120 // Destination
                );

                try {
                    const { data: { text } } = await worker.recognize(canvas);
                    const match = text.match(/\d+\.\d{2}/); // Look for 0.00 pattern

                    if (match) {
                        const price = parseFloat(match[0]);
                        
                        // Prevent duplicate scans of the same price in a row
                        if (price !== lastScannedPrice) {
                            addPrice(price);
                            lastScannedPrice = price;
                            // Vibrate phone on success
                            if (navigator.vibrate) navigator.vibrate(100); 
                            
                            // Pause scanning for 3 seconds to let user move to next item
                            status.innerText = `Added $${price.toFixed(2)}! Pausing...`;
                            setTimeout(() => { 
                                isProcessing = false; 
                                status.innerText = "Ready for next item";
                            }, 3000); 
                        } else {
                            isProcessing = false;
                        }
                    } else {
                        isProcessing = false;
                    }
                } catch (e) {
                    isProcessing = false;
                }
            }, 1000); // Check every 1 second
        }

        function addPrice(price) {
            grandTotal += price;
            totalDisplay.innerText = `$${grandTotal.toFixed(2)}`;
            const li = document.createElement('li');
            li.innerHTML = `<span>Scanned Item</span><strong>$${price.toFixed(2)}</strong>`;
            document.getElementById('item-list').prepend(li);
        }

        window.addEventListener('load', initCamera);
    </script>
</body>
</html>